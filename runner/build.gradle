apply plugin: 'java'

task run(type: JavaExec) {
    classpath = sourceSets.main.runtimeClasspath
    main = 'org.reluxa.Runner'
    workingDir = project.rootProject.projectDir
    args = [project.buildDir.getAbsolutePath() + "project.depenendencies"];
}

project.gradle.projectsEvaluated {
    project(":infra").getSubprojects().each { p ->
        println "Adding dependency to " + p.name;
        run.dependsOn p.tasks.jar
        run.dependsOn project.tasks.printdep
    }
    project(":services").getSubprojects().each { p ->
        println "Adding dependency to " + p.name;
        run.dependsOn p.tasks.jar
        run.dependsOn project.tasks.printdep
    }
}

configure(run) {
    group = 'application'
    description = 'Running the Runner'
}

dependencies {
    //compile 'org.springframework.boot:spring-boot-starter-logging'
    compile 'commons-io:commons-io'
    compile 'com.google.guava:guava'
}


def getPriority(Project myProject) {
    return myProject.hasProperty("priority") ? myProject.priority : 10
}

/*
Collects dependencies into project.depenendencies in the format of
    <path to service thin jar file name>|<main class name>|<classpath of service>
 */
task printdep {
    doLast {
        def deps = new File(project.buildDir.getAbsolutePath() + "project.depenendencies");
        deps.createNewFile();
        deps.write("");

        def projects = new HashSet();
        projects.addAll(project(":infra").getSubprojects());
        projects.addAll(project(":services").getSubprojects());

        projects.each { p ->
            deps.append(p.libsDir.getAbsolutePath() + File.separator + p.tasks.jar.archiveName + "|"
                    + p.mainClassName + "|"
                    + getPriority(p) + "|"
                    + p.configurations.runtime.asPath + "\n");
        }
    }
}
